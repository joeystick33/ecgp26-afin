"""
Module d'analyse IA p√©dagogique
Utilise un LLM pour g√©n√©rer des explications et analyses contextualis√©es
"""

from typing import Dict, Any, List, Optional
import json
import os
from openai import AsyncOpenAI


class AnalyseurIA:
    """Classe pour l'analyse p√©dagogique via IA"""
    
    def __init__(self, api_key: Optional[str] = None):
        """
        Initialise le client OpenAI
        """
        self.api_key = api_key or os.getenv("OPENAI_API_KEY")
        self.client = AsyncOpenAI(api_key=self.api_key) if self.api_key else None
        self.model = "gpt-4o-mini"
    
    async def analyser_resultats_financiers(
        self, 
        sig: Dict[str, float],
        ratios: Dict[str, Any],
        diagnostic: Dict[str, Any],
        contexte: str = "PME industrielle",
        sig_n1: Optional[Dict[str, float]] = None,
        ratios_n1: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """
        Analyse les r√©sultats financiers et g√©n√®re une explication p√©dagogique
        """
        if not self.client:
            return self._analyse_fallback(sig, ratios, diagnostic)
        
        prompt = self._construire_prompt_analyse(sig, ratios, diagnostic, contexte, sig_n1, ratios_n1)
        
        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {
                        "role": "system",
                        "content": self._get_system_prompt()
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                temperature=0.3,
                max_tokens=15000
            )
            
            analyse_text = response.choices[0].message.content
            
            return {
                "analyse_complete": analyse_text,
                "modele_utilise": self.model,
                "entreprise": contexte
            }
            
        except Exception as e:
            print(f"Erreur lors de l'analyse IA: {str(e)}")
            return self._analyse_fallback(sig, ratios, diagnostic)
    
    def _get_system_prompt(self) -> str:
        """
        Retourne le prompt syst√®me de l'analyste financier senior (EXACT du USER)
        """
        return """Je suis un analyste financier confirm√© avec plus de 10 ans d'exp√©rience dans le financement des professionnels. Je suis capable d'analyser des √©tats financiers complexes, d'interpr√©ter une large gamme de ratios financiers et d'√©valuer la solvabilit√© d'une entreprise avec une grande pr√©cision. Mon objectif est de fournir un audit financier complet et une analyse d√©taill√©e pour justifier une d√©cision d'octroi de cr√©dit, en consid√©rant diff√©rents sc√©narios.

Pour chaque section ci-dessous, je fournis une analyse d√©taill√©e en expliquant chaque chiffre et en l'interpr√©tant dans le contexte de l'entreprise et de son secteur. J'int√®gre une analyse exhaustive des ratios financiers, j'identifie les forces et faiblesses, j'√©value la capacit√© d'autofinancement et j'analyse diff√©rents sc√©narios. Pour chaque ratio, j'effectue une comparaison avec les normes du secteur (si disponibles) ou les benchmarks g√©n√©ralement admis, et je commente la situation de l'entreprise au regard de ces r√©f√©rences. J'utilise un ton professionnel, humain, narratif, explicatif et p√©dagogue, comme si je m'adresse √† un comit√© de cr√©dit exp√©riment√©. J'int√®gre une section d√©di√©e aux strat√©gies d'am√©lioration et √† l'√©valuation de leur impact potentiel.

IMPORTANT : 
- Ton HUMAIN, NARRATIF, EXPLICATIF et P√âDAGOGUE
- Explique CHAQUE chiffre dans son contexte
- Compare CHAQUE ratio aux normes sectorielles avec justification
- Structure OBLIGATOIRE en 10 sections d√©taill√©es (voir instructions)
- Utilise des phrases compl√®tes et fluides, pas de style t√©l√©graphique
- Raconte l'histoire financi√®re de l'entreprise"""
    
    def _construire_prompt_analyse(
        self,
        sig: Dict[str, float],
        ratios: Dict[str, Any],
        diagnostic: Dict[str, Any],
        contexte: str,
        sig_n1: Optional[Dict[str, float]] = None,
        ratios_n1: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        Construit le prompt pour l'audit professionnel complet
        """
        # Construire section comparaison N vs N-1
        comparaison_section = ""
        if sig_n1 and ratios_n1:
            # Calculer les √©volutions
            evol_ca = ((sig['production_exercice'] - sig_n1['production_exercice']) / sig_n1['production_exercice'] * 100) if sig_n1['production_exercice'] != 0 else 0
            evol_va = ((sig['valeur_ajoutee'] - sig_n1['valeur_ajoutee']) / sig_n1['valeur_ajoutee'] * 100) if sig_n1['valeur_ajoutee'] != 0 else 0
            evol_ebe = ((sig['excedent_brut_exploitation'] - sig_n1['excedent_brut_exploitation']) / sig_n1['excedent_brut_exploitation'] * 100) if sig_n1['excedent_brut_exploitation'] != 0 else 0
            evol_rn = ((sig['resultat_net'] - sig_n1['resultat_net']) / sig_n1['resultat_net'] * 100) if sig_n1['resultat_net'] != 0 else 0
            
            comparaison_section = f"""

√âTATS FINANCIERS (Ann√©e N-1) - COMPARAISON:

COMPTE DE R√âSULTAT N-1:
- Production de l'exercice: {sig_n1['production_exercice']:,.0f} ‚Ç¨ ‚Üí N: {sig['production_exercice']:,.0f} ‚Ç¨ (√âvolution: {evol_ca:+.1f}%)
- Valeur ajout√©e: {sig_n1['valeur_ajoutee']:,.0f} ‚Ç¨ ‚Üí N: {sig['valeur_ajoutee']:,.0f} ‚Ç¨ (√âvolution: {evol_va:+.1f}%)
- EBE: {sig_n1['excedent_brut_exploitation']:,.0f} ‚Ç¨ ‚Üí N: {sig['excedent_brut_exploitation']:,.0f} ‚Ç¨ (√âvolution: {evol_ebe:+.1f}%)
- R√©sultat net: {sig_n1['resultat_net']:,.0f} ‚Ç¨ ‚Üí N: {sig['resultat_net']:,.0f} ‚Ç¨ (√âvolution: {evol_rn:+.1f}%)

RATIOS FINANCIERS N-1 vs N:

Structure financi√®re:
- Ratio d'endettement: {ratios_n1['structure_financiere']['ratio_endettement']:.2%} ‚Üí {ratios['structure_financiere']['ratio_endettement']:.2%}
- Autonomie financi√®re: {ratios_n1['structure_financiere']['autonomie_financiere']:.2%} ‚Üí {ratios['structure_financiere']['autonomie_financiere']:.2%}

Rentabilit√©:
- Marge nette: {ratios_n1['rentabilite']['marge_nette']:.2%} ‚Üí {ratios['rentabilite']['marge_nette']:.2%}
- ROE: {ratios_n1['rentabilite']['roe']:.2%} ‚Üí {ratios['rentabilite']['roe']:.2%}
- ROA: {ratios_n1['rentabilite']['roa']:.2%} ‚Üí {ratios['rentabilite']['roa']:.2%}

IMPORTANT: ANALYSE OBLIGATOIRE DES √âVOLUTIONS
- Explique les √©volutions significatives (> 10%)
- Identifie les tendances positives et n√©gatives
- Compare l'√©volution des ratios aux normes du secteur
- Analyse si l'am√©lioration/d√©gradation est structurelle ou conjoncturelle
"""
        
        # Extraire nom et secteur du contexte
        if '(' in contexte and ')' in contexte:
            nom_entreprise = contexte.split('(')[0].strip()
            secteur = contexte.split('(')[1].replace(')', '').strip()
        else:
            nom_entreprise = contexte
            secteur = "Secteur non sp√©cifi√©"
        
        print(f"üéØ IA - Contexte re√ßu: '{contexte}'")
        print(f"üéØ IA - Entreprise extraite: '{nom_entreprise}'")
        print(f"üéØ IA - Secteur extrait: '{secteur}'")
        
        prompt = f"""
R√âALISER UN AUDIT FINANCIER COMPLET DE L'ENTREPRISE {nom_entreprise}

Ta t√¢che : R√©aliser un audit financier complet et analyser la situation financi√®re de l'entreprise {nom_entreprise}, puis produire un rapport d√©taill√© destin√© √† un comit√© de cr√©dit. Inclure des propositions de strat√©gies d'am√©lioration et √©valuer leur impact potentiel sur la situation financi√®re.

DONN√âES D'ENTR√âE :

√âTATS FINANCIERS (Ann√©e N - Plus r√©cente):

COMPTE DE R√âSULTAT:
- Production de l'exercice: {sig['production_exercice']:,.0f} ‚Ç¨
- Valeur ajout√©e: {sig['valeur_ajoutee']:,.0f} ‚Ç¨
- EBE: {sig['excedent_brut_exploitation']:,.0f} ‚Ç¨
- EBITDA: {sig.get('ebitda', sig['excedent_brut_exploitation']):,.0f} ‚Ç¨
- R√©sultat d'exploitation: {sig['resultat_exploitation']:,.0f} ‚Ç¨
- R√©sultat courant avant imp√¥t: {sig['resultat_courant_avant_impot']:,.0f} ‚Ç¨
- R√©sultat net: {sig['resultat_net']:,.0f} ‚Ç¨

RATIOS FINANCIERS:

Structure financi√®re:
- Ratio d'endettement: {ratios['structure_financiere']['ratio_endettement']:.2%}
- Autonomie financi√®re: {ratios['structure_financiere']['autonomie_financiere']:.2%}
- Gearing: {ratios['structure_financiere']['gearing']:.2f}

Rentabilit√©:
- Marge nette: {ratios['rentabilite']['marge_nette']:.2%}
- ROE: {ratios['rentabilite']['roe']:.2%}
- ROA: {ratios['rentabilite']['roa']:.2%}
- Rentabilit√© √©conomique: {ratios['rentabilite']['rentabilite_economique']:.2%}

Liquidit√©:
- Ratio de liquidit√© g√©n√©rale: {ratios['liquidite']['ratio_liquidite_generale']:.2f}
- Ratio de liquidit√© imm√©diate: {ratios['liquidite']['ratio_liquidite_immediate']:.2f}

Activit√©:
- D√©lai clients: {ratios.get('activite', {}).get('delai_clients', 0):.0f} jours
- D√©lai fournisseurs: {ratios.get('activite', {}).get('delai_fournisseurs', 0):.0f} jours{comparaison_section}

INSTRUCTIONS :

Pour chaque section ci-dessous, fournis une analyse d√©taill√©e en expliquant chaque chiffre et en l'interpr√©tant dans le contexte de l'entreprise et de son secteur. Utilise un TON PROFESSIONNEL, HUMAIN, NARRATIF, EXPLICATIF et P√âDAGOGUE. Raconte l'histoire financi√®re de l'entreprise.

1. INTRODUCTION ET SYNTH√àSE (Page 1 de la Plaquette)

   ‚Ä¢ D√©crire br√®vement l'entreprise : "L'entreprise {nom_entreprise}, cr√©√©e en [Ann√©e si connue], op√®re dans le secteur {secteur} et son activit√© principale est [Activit√© principale d√©duite des donn√©es]."
   
   ‚Ä¢ R√©diger un r√©sum√© analytique : "Apr√®s un audit financier complet des √©tats financiers et des informations fournies, l'entreprise {nom_entreprise} pr√©sente [Forces principales identifi√©es]. Cependant, il convient de noter [Faiblesses principales identifi√©es]. La capacit√© de remboursement, √©valu√©e √† [Nombre] ann√©es sur la base de la CAF actuelle, semble [Forte/Moyenne/Faible] au regard de [Justification]. L'analyse d√©taill√©e ci-apr√®s, incluant une analyse de sensibilit√©, diff√©rents sc√©narios, et des strat√©gies d'am√©lioration, justifie la recommandation [Approbation/Approbation sous conditions/Refus]."
   
   ‚Ä¢ Formuler la recommandation : "En conclusion, je recommande [D√©cision] avec les garanties suivantes : [Liste des garanties sugg√©r√©es]. Les covenants suivants devront √™tre respect√©s : [Liste des covenants]. Des conditions particuli√®res sont √©galement √† pr√©voir : [Liste des conditions]."

2. PR√âSENTATION DE L'ENTREPRISE ET DE SON ENVIRONNEMENT (Page 2 de la Plaquette)

   ‚Ä¢ D√©crire l'entreprise : "L'entreprise {nom_entreprise} cible une client√®le [Description d√©duite du secteur] et se positionne sur le march√© comme [Positionnement d√©duit des ratios]. Ses avantages concurrentiels apparents sont [Avantages d√©duits de la performance]."
   
   ‚Ä¢ Analyser le march√© : "Le march√© {secteur} est [Caract√©risation du march√© : en croissance, mature, en d√©clin selon l'√©volution du CA]. Les principales tendances sont [Tendances du secteur]. Les facteurs cl√©s de succ√®s sont [Facteurs cl√©s de succ√®s typiques du secteur]."
   
   ‚Ä¢ √âvaluer la gouvernance : "La gouvernance de l'entreprise semble [Saine/Correcte/√Ä am√©liorer] en raison de [Justification bas√©e sur les ratios de structure]."

3. ANALYSE FINANCI√àRE - PERFORMANCE ET RENTABILIT√â (Page 3 de la Plaquette)

   ‚Ä¢ Analyser les SIG (Soldes Interm√©diaires de Gestion) :
   
   - "Le chiffre d'affaires{' est pass√© de ' + f'{sig_n1["production_exercice"]:,.0f} ‚Ç¨ √† ' if sig_n1 else ' s√©tablit √† '}{sig['production_exercice']:,.0f} ‚Ç¨{', soit une √©volution de ' + f'{((sig["production_exercice"] - sig_n1["production_exercice"]) / sig_n1["production_exercice"] * 100):+.1f}%' if sig_n1 else ''}. Cette √©volution est [Sup√©rieure/Conforme/Inf√©rieure] √† la croissance moyenne du secteur {secteur}. Une croissance sup√©rieure √† celle du secteur indique une prise de parts de march√©, ce qui est un signe positif de dynamisme commercial."
   
   - "La valeur ajout√©e est de {sig['valeur_ajoutee']:,.0f} ‚Ç¨{' (contre ' + f'{sig_n1["valeur_ajoutee"]:,.0f} ‚Ç¨ en N-1)' if sig_n1 else ''}. La valeur ajout√©e repr√©sente la richesse cr√©√©e par l'entreprise. Son √©volution doit √™tre mise en regard de celle du chiffre d'affaires et des charges de personnel."
   
   - "L'EBE atteint {sig['excedent_brut_exploitation']:,.0f} ‚Ç¨{', soit ' + f'{((sig["excedent_brut_exploitation"] - sig_n1["excedent_brut_exploitation"]) / sig_n1["excedent_brut_exploitation"] * 100):+.1f}% par rapport √† N-1' if sig_n1 else ''}, repr√©sentant {(sig['excedent_brut_exploitation'] / sig['production_exercice'] * 100):.1f}% du CA. Cette performance est [Sup√©rieure/En ligne/Inf√©rieure] √† la moyenne du secteur qui se situe g√©n√©ralement entre 15% et 25% pour le secteur {secteur}. L'EBE est un indicateur cl√© de la rentabilit√© op√©rationnelle de l'entreprise, avant prise en compte des politiques d'amortissement, de financement et d'√©l√©ments exceptionnels."
   
   - "Le r√©sultat d'exploitation suit la m√™me tendance avec une valeur de {sig['resultat_exploitation']:,.0f} ‚Ç¨. Le r√©sultat d'exploitation refl√®te la performance industrielle et commerciale de l'entreprise."
   
   - "Le r√©sultat net, apr√®s prise en compte des √©l√©ments financiers et exceptionnels, s'√©tablit √† {sig['resultat_net']:,.0f} ‚Ç¨{' (contre ' + f'{sig_n1["resultat_net"]:,.0f} ‚Ç¨ en N-1)' if sig_n1 else ''}. Le r√©sultat net est le b√©n√©fice r√©alis√© par l'entreprise apr√®s imp√¥ts."
   
   ‚Ä¢ Analyse des ratios de rentabilit√© :
   
   - "La rentabilit√© √©conomique (R√©sultat d'exploitation / Actif √©conomique) est de {ratios['rentabilite']['rentabilite_economique'] * 100:.2f}%. Ce ratio mesure la capacit√© de l'entreprise √† g√©n√©rer du profit √† partir de ses actifs √©conomiques. Une rentabilit√© √©conomique sup√©rieure √† 10% est g√©n√©ralement consid√©r√©e comme satisfaisante."
   
   - "La marge nette (R√©sultat net / Chiffre d'affaires) est de {ratios['rentabilite']['marge_nette'] * 100:.2f}%. Ce ratio indique la part du chiffre d'affaires qui se transforme en b√©n√©fice net. Une marge nette de 5% est courante dans de nombreux secteurs."
   
   - "Le Return On Equity (ROE) est de {ratios['rentabilite']['roe'] * 100:.2f}%. Ce ratio est un indicateur cl√© pour les actionnaires. Un ROE sup√©rieur √† 15% est souvent recherch√©."
   
   - "Le Return On Assets (ROA) est de {ratios['rentabilite']['roa'] * 100:.2f}%. Ce ratio mesure la rentabilit√© globale de l'entreprise par rapport √† l'ensemble de ses actifs. Un ROA sup√©rieur √† 5% est g√©n√©ralement consid√©r√© comme positif."
   
   - Interpr√©tation : "Ces ratios indiquent que la rentabilit√© de l'entreprise est [Forte/Moyenne/Faible selon les valeurs] et [Sup√©rieure/En ligne/Inf√©rieure] √† celle du secteur. La rentabilit√© des capitaux propres est {'sup√©rieure' if ratios['rentabilite']['roe'] > ratios['rentabilite']['rentabilite_economique'] else 'inf√©rieure'} √† la rentabilit√© √©conomique, ce qui sugg√®re un effet de levier {'positif' if ratios['rentabilite']['roe'] > ratios['rentabilite']['rentabilite_economique'] else 'n√©gatif'}. Un effet de levier positif signifie que l'endettement contribue √† am√©liorer la rentabilit√© des capitaux propres."

4. ANALYSE FINANCI√àRE - STRUCTURE, SOLVABILIT√â ET TR√âSORERIE (Page 4 de la Plaquette)

   ‚Ä¢ Analyse des ratios de structure financi√®re :
   
   - "Le ratio d'endettement global (Total des dettes / Capitaux propres) est de {ratios['structure_financiere']['ratio_endettement'] / ratios['structure_financiere']['autonomie_financiere']:.2f}. Ce ratio mesure le niveau d'endettement global de l'entreprise par rapport √† ses fonds propres. Un ratio inf√©rieur √† 1 est g√©n√©ralement pr√©f√©rable, mais cela d√©pend de la structure financi√®re du secteur {secteur}."
   
   - "Le ratio d'autonomie financi√®re (Capitaux propres / Total bilan) est de {ratios['structure_financiere']['autonomie_financiere']:.2%}. Ce ratio mesure la part des fonds propres dans le financement de l'entreprise. Un ratio sup√©rieur √† 30% est souvent consid√©r√© comme un minimum. Une augmentation de ce ratio indique un renforcement de la structure financi√®re."
   
   - "Le gearing (Dettes nettes / Capitaux propres + Dettes nettes) est de {ratios['structure_financiere']['gearing']:.2f}. Ce ratio mesure la part de l'endettement net dans le financement global de l'entreprise. Un gearing inf√©rieur √† 1 est g√©n√©ralement souhaitable, et un ratio inf√©rieur √† 0,5 est souvent consid√©r√© comme un signe de solidit√© financi√®re."
   
   - Interpr√©tation : "La structure financi√®re de l'entreprise est [Solide/√âquilibr√©e/Fragile selon les valeurs]. L'endettement est [Ma√Ætris√©/Important/Excessif] au regard des ratios du secteur. Il est important de mettre en perspective les ratios d'endettement avec la capacit√© de remboursement de l'entreprise."
   
   ‚Ä¢ Analyse des ratios de liquidit√© :
   
   - "Le ratio de liquidit√© g√©n√©rale (Actif circulant / Passif circulant) est de {ratios['liquidite']['ratio_liquidite_generale']:.2f}. Ce ratio mesure la capacit√© de l'entreprise √† faire face √† ses dettes √† court terme avec ses actifs √† court terme. Un ratio sup√©rieur √† 1 est g√©n√©ralement consid√©r√© comme le minimum acceptable, et un ratio sup√©rieur √† 1,5 est souvent recherch√©."
   
   - "Le ratio de liquidit√© imm√©diate (Tr√©sorerie / Passif circulant) est de {ratios['liquidite']['ratio_liquidite_immediate']:.2f}. Ce ratio mesure la capacit√© de l'entreprise √† faire face √† ses dettes √† court terme avec sa tr√©sorerie disponible. Un ratio sup√©rieur √† 0,3 est souvent consid√©r√© comme un bon niveau."
   
   - Interpr√©tation : "La liquidit√© de l'entreprise est [Bonne/Suffisante/Pr√©occupante selon les valeurs]. Une situation de liquidit√© tendue peut fragiliser l'entreprise en cas de difficult√©s conjoncturelles."
   
   ‚Ä¢ Analyse des ratios de rotation et de gestion du BFR :
   
   - "Le d√©lai de r√®glement clients est de {ratios.get('activite', {}).get('delai_clients', 0):.0f} jours. Ce ratio mesure le nombre de jours de cr√©dit accord√© aux clients. Un d√©lai trop long peut peser sur la tr√©sorerie de l'entreprise. Il est important de le comparer aux pratiques du secteur {secteur}."
   
   - "Le d√©lai de r√®glement fournisseurs est de {ratios.get('activite', {}).get('delai_fournisseurs', 0):.0f} jours. Ce ratio mesure le nombre de jours de cr√©dit obtenu aupr√®s des fournisseurs. Un d√©lai plus long que celui des clients est favorable pour la tr√©sorerie de l'entreprise."
   
   - Interpr√©tation : "La gestion du BFR est [Efficace/Moyenne/Inefficace selon les valeurs]. Une mauvaise gestion du BFR peut entra√Æner des tensions de tr√©sorerie et un besoin de financement accru."

5. ANALYSE DE LA CAPACIT√â D'AUTOFINANCEMENT (CAF) - Page 5 de la Plaquette

   - "La CAF repr√©sente la capacit√© de l'entreprise √† g√©n√©rer des ressources internes pour financer ses investissements et rembourser ses dettes. Elle se calcule selon deux m√©thodes :"
   
   - M√©thode soustractive : CAF = EBE + Produits encaissables - Charges d√©caissables
   - M√©thode additive : CAF = R√©sultat net + Dotations aux amortissements et provisions
   
   - "Sur la base des donn√©es disponibles, la CAF peut √™tre estim√©e √† environ {sig['excedent_brut_exploitation'] * 0.8:,.0f} ‚Ç¨ (estimation conservatrice √† 80% de l'EBE). Cette CAF repr√©sente environ {(sig['excedent_brut_exploitation'] * 0.8) / sig['production_exercice'] * 100:.1f}% du chiffre d'affaires."
   
   - "La CAF permet √† l'entreprise de financer ses investissements courants et le remboursement de ses dettes. Une CAF en progression est un signe positif de la capacit√© de l'entreprise √† g√©n√©rer des ressources internes."

6. ANALYSE DES FLUX DE TR√âSORERIE (Page 6 de la Plaquette)

   - "L'analyse des flux de tr√©sorerie permet de comprendre comment l'entreprise g√©n√®re et utilise sa tr√©sorerie. Les flux se d√©composent en trois cat√©gories :"
   
   - "Le flux de tr√©sorerie d'exploitation repr√©sente la tr√©sorerie g√©n√©r√©e par l'activit√© courante de l'entreprise. Il doit √™tre positif et en ligne avec la CAF pour refl√©ter une bonne sant√© financi√®re."
   
   - "Le flux de tr√©sorerie d'investissement retrace les d√©penses d'investissement de l'entreprise. Un flux n√©gatif est normal pour une entreprise en croissance qui investit. Il faut toutefois s'assurer que ces investissements sont pertinents et financ√©s par des ressources stables."
   
   - "Le flux de tr√©sorerie de financement retrace les op√©rations de haut de bilan (augmentation de capital, emprunts, remboursements de dettes, dividendes). Il permet de comprendre comment l'entreprise finance ses activit√©s et ses investissements."

7. ANALYSE DES RISQUES ET PR√âVISIONS (Page 7 de la Plaquette)

   ‚Ä¢ Analyser les risques :
   
   - "Risques Financiers : Le risque de cr√©dit est [Faible/Mod√©r√©/√âlev√© selon les ratios] en raison de la capacit√© de remboursement et du niveau d'endettement observ√©s. Le risque de liquidit√© est [Faible/Mod√©r√©/√âlev√©] compte tenu des ratios de liquidit√©."
   
   - "Risques Op√©rationnels : L'entreprise est expos√©e √† des risques li√©s au secteur {secteur}, notamment [Risques sp√©cifiques au secteur]. La d√©pendance √©ventuelle √† certains clients ou fournisseurs constitue √©galement un point de vigilance."
   
   - "Risques Externes : L'entreprise pourrait √™tre impact√©e par l'√©volution de la r√©glementation dans le secteur {secteur}, par des facteurs √©conomiques (inflation, r√©cession) ou par des changements de comportement des consommateurs."

8. ANALYSE DE SENSIBILIT√â ET SC√âNARIOS (Page 8 de la Plaquette)

   ‚Ä¢ D√©finir des sc√©narios :
   
   - "Sc√©nario optimiste : Dans un sc√©nario optimiste, bas√© sur une croissance du chiffre d'affaires de +15% et une am√©lioration de la marge brute de +2 points, la CAF pourrait atteindre {sig['excedent_brut_exploitation'] * 1.15 * 0.8:,.0f} ‚Ç¨ et la capacit√© de remboursement s'am√©liorerait significativement."
   
   - "Sc√©nario pessimiste : Dans un sc√©nario pessimiste, avec une baisse du chiffre d'affaires de -10% et une d√©gradation de la marge brute de -2 points, la CAF serait r√©duite √† environ {sig['excedent_brut_exploitation'] * 0.9 * 0.8:,.0f} ‚Ç¨ et la capacit√© de remboursement serait d√©grad√©e."
   
   - "Sc√©nario central : Sur la base des tendances observ√©es et des pr√©visions du secteur, un sc√©nario central table sur une croissance mod√©r√©e du chiffre d'affaires de +5% et une stabilit√© des marges."
   
   - "L'analyse de sensibilit√© montre que l'entreprise est [R√©sistante/Vuln√©rable selon les ratios] aux variations des hypoth√®ses cl√©s. Les principaux facteurs de risque identifi√©s sont [Liste des facteurs de risque]."

9. FORCES ET FAIBLESSES (Page 9 de la Plaquette)

   ‚Ä¢ Lister les forces de l'entreprise :
   
   - "Forces : [Identifier les forces bas√©es sur les ratios sup√©rieurs aux normes : par exemple, rentabilit√© sup√©rieure √† la moyenne du secteur si marge nette > 5%, bonne ma√Ætrise du BFR si d√©lais optimis√©s, structure financi√®re solide si autonomie > 40%, etc.]"
   
   ‚Ä¢ Lister les faiblesses de l'entreprise :
   
   - "Faiblesses : [Identifier les faiblesses bas√©es sur les ratios inf√©rieurs aux normes : par exemple, endettement √©lev√© si ratio > 60%, faible liquidit√© si ratio < 1, rentabilit√© faible si marge nette < 3%, etc.]"
   
   ‚Ä¢ Analyser : "Les forces de l'entreprise lui conf√®rent des avantages concurrentiels et une solidit√© financi√®re relative. Cependant, les faiblesses identifi√©es constituent des points de vigilance et pourraient impacter la p√©rennit√© de l'entreprise en cas de retournement conjoncturel."

10. STRAT√âGIES D'AM√âLIORATION (Page 10 de la Plaquette)

   ‚Ä¢ Proposer des strat√©gies d'am√©lioration concr√®tes :
   
   - "Afin d'am√©liorer la situation financi√®re de l'entreprise {nom_entreprise}, il est recommand√© de mettre en ≈ìuvre les strat√©gies suivantes :"
   
   - "Am√©lioration de la rentabilit√© : Optimiser les charges d'exploitation (r√©duire de 5% les charges externes pourrait am√©liorer l'EBE de {sig['production_exercice'] * 0.05:,.0f} ‚Ç¨), am√©liorer la politique tarifaire pour accro√Ætre la marge brute, d√©velopper de nouveaux produits ou services √† plus forte marge."
   
   - "Am√©lioration de la structure financi√®re : R√©duire l'endettement par un remboursement anticip√© ou une augmentation de capital, renforcer les fonds propres, n√©gocier de meilleures conditions de financement (taux d'int√©r√™t, dur√©e)."
   
   - "Am√©lioration de la gestion du BFR : R√©duire le d√©lai de r√®glement clients (une r√©duction de 10 jours lib√©rerait environ {sig['production_exercice'] * 10 / 365:,.0f} ‚Ç¨ de tr√©sorerie), optimiser la gestion des stocks, n√©gocier de meilleurs d√©lais de paiement avec les fournisseurs."
   
   - "Autres mesures : Investir dans la digitalisation pour am√©liorer l'efficacit√© op√©rationnelle, d√©velopper la formation des √©quipes, mettre en place un contr√¥le de gestion rigoureux."
   
   ‚Ä¢ √âvaluer l'impact potentiel :
   
   - "La mise en ≈ìuvre de ces strat√©gies pourrait avoir un impact positif significatif sur les indicateurs financiers de l'entreprise. Par exemple, une r√©duction des charges de 5% et une augmentation du chiffre d'affaires de 10% permettraient d'am√©liorer l'EBE de {sig['production_exercice'] * 0.10 * 0.2:,.0f} ‚Ç¨ environ. Une r√©duction du d√©lai de r√®glement clients de 15 jours permettrait de diminuer le BFR et d'am√©liorer la tr√©sorerie."
   
   - "Sc√©nario de redressement : En combinant plusieurs mesures d'am√©lioration (optimisation charges, croissance CA, am√©lioration BFR), on peut envisager un sc√©nario de redressement dans lequel le chiffre d'affaires progresserait de 15%, l'EBE s'am√©liorerait de 25%, et la CAF augmenterait de 30% sur 3 ans. Ce sc√©nario permettrait de r√©duire significativement le ratio d'endettement et d'am√©liorer la capacit√© de remboursement."

---

CONCLUSION :

En conclusion, r√©dige une synth√®se finale de 2-3 paragraphes avec ta recommandation finale (Approbation/Approbation sous conditions/Refus) en justifiant par les points cl√©s de l'analyse. Sois clair, pr√©cis et p√©dagogue.

IMPORTANT : 
- Utilise un TON NARRATIF, HUMAIN et P√âDAGOGUE tout au long du rapport
- Explique CHAQUE chiffre dans son contexte
- Compare syst√©matiquement aux normes du secteur {secteur}
- Raconte l'histoire financi√®re de l'entreprise de mani√®re fluide
- √âvite le style t√©l√©graphique, utilise des phrases compl√®tesiel chiffr√©
    - Sc√©nario de redressement

EXIGENCES :
- Ton professionnel et pr√©cis
- Comparer CHAQUE ratio aux normes du secteur
{{ ... }}
- Justifier TOUTES les conclusions par des chiffres
- Fournir des interpr√©tations d√©taill√©es
- Proposer des recommandations actionnables

G√©n√®re le rapport complet maintenant.
"""
        return prompt
    
    def _analyse_fallback(
        self,
        sig: Dict[str, float],
        ratios: Dict[str, Any],
        diagnostic: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Analyse de secours si l'IA n'est pas disponible
        """
        analyse = f"""
üìä ANALYSE AUTOMATIQUE DE VOS R√âSULTATS

üéØ Score de sant√© financi√®re: {diagnostic['score_total']}/{diagnostic['score_max']}
{diagnostic['niveau_global']}

üìà VUE D'ENSEMBLE:
Votre entreprise pr√©sente les caract√©ristiques suivantes:
- Rentabilit√©: {diagnostic['details']['rentabilite']['statut']}
- Structure financi√®re: {diagnostic['details']['structure_financiere']['statut']}
- Liquidit√©: {diagnostic['details']['liquidite']['statut']}
- Activit√©: {diagnostic['details']['activite']['statut']}

üîç ANALYSE D√âTAILL√âE:

üí∞ Rentabilit√©:
- Votre marge nette est de {ratios['rentabilite']['marge_nette']:.2%}, ce qui signifie que {ratios['rentabilite']['marge_nette']*100:.1f}‚Ç¨ de b√©n√©fice net sont g√©n√©r√©s pour chaque 100‚Ç¨ de chiffre d'affaires.
- Le ROE de {ratios['rentabilite']['roe']:.2%} indique la rentabilit√© pour les actionnaires.
- L'EBE de {sig['excedent_brut_exploitation']:,.0f}‚Ç¨ mesure la performance op√©rationnelle avant impacts financiers et fiscaux.

üè¶ Structure financi√®re:
- Ratio d'endettement: {ratios['structure_financiere']['ratio_endettement']:.2%}
  {'‚úÖ Endettement ma√Ætris√©' if ratios['structure_financiere']['ratio_endettement'] < 0.5 else '‚ö†Ô∏è Endettement √† surveiller' if ratios['structure_financiere']['ratio_endettement'] < 0.7 else 'üî¥ Endettement √©lev√©'}
- Autonomie financi√®re: {ratios['structure_financiere']['autonomie_financiere']:.2%}
  {'‚úÖ Bonne autonomie' if ratios['structure_financiere']['autonomie_financiere'] > 0.4 else '‚ö†Ô∏è Autonomie limit√©e'}

üíß Liquidit√©:
- Ratio de liquidit√© g√©n√©rale: {ratios['liquidite']['ratio_liquidite_generale']:.2f}
  {'‚úÖ Capacit√© √† payer les dettes court terme' if ratios['liquidite']['ratio_liquidite_generale'] > 1 else 'üî¥ Risque de liquidit√©'}

üí° POUR APPROFONDIR:
- Comparez ces r√©sultats avec ceux des ann√©es pr√©c√©dentes
- Analysez l'√©volution des marges dans le temps
- √âtudiez la structure du BFR (Besoin en Fonds de Roulement)

üìö Besoin d'aide? Utilisez le chat p√©dagogique pour poser vos questions!
"""
        
        return {
            "analyse_complete": analyse,
            "modele_utilise": "analyse_automatique"
        }
    
    async def generer_questions_quiz(
        self,
        sig: Dict[str, float],
        ratios: Dict[str, Any],
        niveau: str = "d√©butant"
    ) -> List[Dict[str, Any]]:
        """
        G√©n√®re des questions de quiz contextualis√©es
        """
        if not self.client:
            return self._quiz_fallback(sig, ratios, niveau)
        
        prompt = f"""
G√©n√®re 4 questions de compr√©hension de type QCM bas√©es sur les r√©sultats financiers suivants:

SIG:
- EBE: {sig['excedent_brut_exploitation']:,.0f} ‚Ç¨
- R√©sultat net: {sig['resultat_net']:,.0f} ‚Ç¨
- Marge nette: {ratios['rentabilite']['marge_nette']:.2%}

Ratios:
- Ratio d'endettement: {ratios['structure_financiere']['ratio_endettement']:.2%}
- ROE: {ratios['rentabilite']['roe']:.2%}
- Liquidit√© g√©n√©rale: {ratios['liquidite']['ratio_liquidite_generale']:.2f}

Niveau: {niveau}

Format de r√©ponse (JSON):
[
  {{
    "question": "La question ici",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "reponse_correcte": 0,
    "explication": "Explication d√©taill√©e de la bonne r√©ponse"
  }}
]

Les questions doivent:
1. Tester la compr√©hension des concepts (pas juste la m√©morisation)
2. √ätre adapt√©es au niveau {niveau}
3. Inclure des questions d'interpr√©tation des r√©sultats r√©els
4. Avoir des explications p√©dagogiques claires
"""
        
        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "Tu es un expert en p√©dagogie financi√®re. G√©n√®re des questions de quiz pertinentes."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.8,
                max_tokens=1000
            )
            
            questions_text = response.choices[0].message.content
            # Extraire le JSON
            start_idx = questions_text.find('[')
            end_idx = questions_text.rfind(']') + 1
            if start_idx != -1 and end_idx > start_idx:
                questions_json = questions_text[start_idx:end_idx]
                questions = json.loads(questions_json)
                return questions
            else:
                return self._quiz_fallback(sig, ratios, niveau)
                
        except Exception as e:
            print(f"Erreur g√©n√©ration quiz: {str(e)}")
            return self._quiz_fallback(sig, ratios, niveau)
    
    def _quiz_fallback(
        self,
        sig: Dict[str, float],
        ratios: Dict[str, Any],
        niveau: str
    ) -> List[Dict[str, Any]]:
        """
        Questions de quiz par d√©faut
        """
        questions = [
            {
                "question": "Que repr√©sente l'Exc√©dent Brut d'Exploitation (EBE)?",
                "options": [
                    "Le r√©sultat net de l'entreprise",
                    "La performance op√©rationnelle avant impacts financiers et fiscaux",
                    "Le chiffre d'affaires total",
                    "Le b√©n√©fice distribu√© aux actionnaires"
                ],
                "reponse_correcte": 1,
                "explication": "L'EBE mesure la performance op√©rationnelle de l'entreprise, c'est-√†-dire ce qu'elle g√©n√®re par son activit√© principale, avant de prendre en compte les √©l√©ments financiers (int√©r√™ts), exceptionnels et fiscaux (imp√¥ts)."
            },
            {
                "question": f"Avec un ratio d'endettement de {ratios['structure_financiere']['ratio_endettement']:.1%}, que peut-on conclure?",
                "options": [
                    "L'entreprise n'a aucune dette",
                    "L'entreprise est en faillite",
                    f"Les dettes repr√©sentent {ratios['structure_financiere']['ratio_endettement']:.0%} du financement total",
                    "L'entreprise doit emprunter davantage"
                ],
                "reponse_correcte": 2,
                "explication": f"Le ratio d'endettement mesure la part des dettes dans le financement total. Ici, {ratios['structure_financiere']['ratio_endettement']:.0%} du financement provient des dettes, le reste provient des capitaux propres."
            },
            {
                "question": "Pourquoi un ratio de liquidit√© g√©n√©rale sup√©rieur √† 1 est-il g√©n√©ralement positif?",
                "options": [
                    "Cela signifie que l'entreprise est tr√®s rentable",
                    "Cela indique que l'actif circulant peut couvrir le passif circulant",
                    "Cela montre que l'entreprise n'a pas de dettes",
                    "Cela garantit que l'entreprise ne fera jamais faillite"
                ],
                "reponse_correcte": 1,
                "explication": "Un ratio > 1 signifie que l'entreprise dispose de suffisamment d'actifs circulants (stocks, cr√©ances, tr√©sorerie) pour payer ses dettes √† court terme. C'est un indicateur de solvabilit√© √† court terme."
            },
            {
                "question": f"Avec une marge nette de {ratios['rentabilite']['marge_nette']:.1%}, que peut-on dire de la rentabilit√©?",
                "options": [
                    f"Pour 100‚Ç¨ de CA, l'entreprise g√©n√®re {ratios['rentabilite']['marge_nette']*100:.1f}‚Ç¨ de b√©n√©fice net",
                    "L'entreprise perd de l'argent",
                    "L'entreprise doit augmenter ses prix",
                    "La marge nette n'est pas importante"
                ],
                "reponse_correcte": 0,
                "explication": f"La marge nette de {ratios['rentabilite']['marge_nette']:.1%} indique qu'apr√®s toutes les charges (op√©rationnelles, financi√®res, fiscales), il reste {ratios['rentabilite']['marge_nette']*100:.1f}‚Ç¨ de b√©n√©fice net pour chaque 100‚Ç¨ de chiffre d'affaires."
            }
        ]
        
        return questions
    
    async def repondre_question_chat(
        self,
        question: str,
        niveau: str = "d√©butant",
        contexte: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        R√©pond √† une question de l'√©tudiant via le chat p√©dagogique
        """
        if not self.client:
            return self._reponse_fallback(question)
        
        contexte_str = ""
        if contexte:
            contexte_str = f"\n\nContexte des r√©sultats analys√©s:\n{json.dumps(contexte, indent=2, ensure_ascii=False)}"
        
        prompt = f"""
Question de l'√©tudiant (niveau {niveau}):
{question}
{contexte_str}

Fournis une r√©ponse claire, p√©dagogique et adapt√©e au niveau {niveau}.
Structure ta r√©ponse avec:
- Une explication simple du concept
- Un exemple concret si pertinent
- Des liens avec le contexte des r√©sultats si fourni
- Des ressources ou pistes pour approfondir

Reste bienveillant et encourageant! üòä
"""
        
        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": self._get_system_prompt(niveau)},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.7,
                max_tokens=800
            )
            
            return response.choices[0].message.content
            
        except Exception as e:
            print(f"Erreur r√©ponse chat: {str(e)}")
            return self._reponse_fallback(question)
    
    def _reponse_fallback(self, question: str) -> str:
        """
        R√©ponse de secours si l'IA n'est pas disponible
        """
        return f"""
Je comprends votre question: "{question}"

Pour obtenir une r√©ponse personnalis√©e et d√©taill√©e, l'assistant IA n√©cessite une cl√© API OpenAI.

En attendant, voici quelques ressources utiles:

üìö Concepts cl√©s de l'analyse financi√®re:
- **SIG (Soldes Interm√©diaires de Gestion)**: indicateurs qui d√©composent la formation du r√©sultat
- **Ratios de structure**: mesurent l'√©quilibre du financement (endettement, autonomie)
- **Ratios de rentabilit√©**: √©valuent la performance (marge, ROE, ROA)
- **Ratios de liquidit√©**: analysent la capacit√© √† payer les dettes court terme

üí° Conseil: Explorez les explications automatiques dans les tableaux de bord et les tooltips!

N'h√©sitez pas √† reformuler votre question ou √† explorer les diff√©rentes sections de l'application.
"""
